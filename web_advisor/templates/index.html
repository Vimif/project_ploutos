{% extends "base.html" %}
{% block title %}Ploutos Advisory - Accueil{% endblock %}

{% block content %}

<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold">Assistant d'Investissement</h1>
    <p class="text-slate-400 text-sm mt-1">Analyse multi-sources : Technique + IA + Sentiment + Previsions</p>
</div>

<!-- Chargement -->
<div id="loading" class="text-center py-20">
    <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
    <p class="text-slate-400">Analyse de la watchlist en cours...</p>
    <p class="text-slate-500 text-sm mt-2">Cela peut prendre quelques minutes</p>
</div>

<!-- Contenu (cache initialement) -->
<div id="main-content" class="hidden">

    <!-- Top Picks -->
    <section class="mb-8">
        <h2 class="text-lg font-semibold mb-4">
            <i class="fas fa-fire text-orange-400 mr-2"></i>Meilleures Opportunites
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Top Achats -->
            <div class="bg-card rounded-lg p-4 border border-slate-700">
                <h3 class="text-emerald-400 font-medium mb-3">
                    <i class="fas fa-arrow-trend-up mr-1"></i>Top Achats
                </h3>
                <div id="top-buys" class="space-y-2"></div>
            </div>
            <!-- Top Ventes -->
            <div class="bg-card rounded-lg p-4 border border-slate-700">
                <h3 class="text-red-400 font-medium mb-3">
                    <i class="fas fa-arrow-trend-down mr-1"></i>Top Ventes
                </h3>
                <div id="top-sells" class="space-y-2"></div>
            </div>
        </div>
    </section>

    <!-- Watchlist -->
    <section id="watchlist" class="mb-8">
        <h2 class="text-lg font-semibold mb-4">
            <i class="fas fa-list text-blue-400 mr-2"></i>Watchlist Complete
        </h2>
        <div id="watchlist-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        </div>
    </section>

</div>

{% endblock %}

{% block scripts %}
<script>
const REC_COLORS = {
    'ACHAT_FORT': { bg: 'bg-emerald-900', text: 'text-emerald-300', label: 'Achat Fort' },
    'ACHAT': { bg: 'bg-emerald-800', text: 'text-emerald-200', label: 'Achat' },
    'NEUTRE': { bg: 'bg-slate-700', text: 'text-slate-300', label: 'Neutre' },
    'VENTE': { bg: 'bg-orange-900', text: 'text-orange-300', label: 'Vente' },
    'VENTE_FORTE': { bg: 'bg-red-900', text: 'text-red-300', label: 'Vente Forte' },
};

function scoreToPercent(score) {
    return Math.round((score + 1) / 2 * 100);
}

function renderPickRow(result) {
    const rec = REC_COLORS[result.recommendation] || REC_COLORS['NEUTRE'];
    const pct = scoreToPercent(result.composite_score);
    return `
        <a href="/analysis/${result.symbol}" class="flex items-center justify-between p-2 rounded hover:bg-hover transition-colors">
            <div class="flex items-center gap-3">
                <span class="font-mono font-bold text-sm w-12">${result.symbol}</span>
                <span class="text-xs ${rec.bg} ${rec.text} px-2 py-0.5 rounded-full">${rec.label}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm">$${result.current_price.toFixed(2)}</span>
                <div class="w-16 bg-slate-700 rounded-full h-2">
                    <div class="h-2 rounded-full ${result.composite_score > 0 ? 'bg-emerald-500' : 'bg-red-500'}"
                         style="width: ${pct}%"></div>
                </div>
                <span class="text-xs text-slate-400 w-8 text-right">${pct}%</span>
            </div>
        </a>
    `;
}

function renderTickerCard(result) {
    const rec = REC_COLORS[result.recommendation] || REC_COLORS['NEUTRE'];
    const pct = scoreToPercent(result.composite_score);

    // Sous-signaux pour sparkline
    const sources = {};
    (result.sub_signals || []).forEach(s => { sources[s.source] = s; });

    return `
        <a href="/analysis/${result.symbol}" class="bg-card rounded-lg p-4 border border-slate-700 hover:border-blue-500 transition-all cursor-pointer block">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <span class="font-mono font-bold text-lg">${result.symbol}</span>
                    <div class="text-sm text-slate-400">$${result.current_price.toFixed(2)}</div>
                </div>
                <span class="${rec.bg} ${rec.text} text-xs px-2 py-1 rounded-full font-medium">
                    ${rec.label}
                </span>
            </div>

            <!-- Jauge score -->
            <div class="mb-3">
                <div class="flex justify-between text-xs text-slate-500 mb-1">
                    <span>Score</span>
                    <span>${(result.composite_score >= 0 ? '+' : '')}${result.composite_score.toFixed(2)}</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5">
                    <div class="h-2.5 rounded-full transition-all ${result.composite_score > 0.2 ? 'bg-emerald-500' : result.composite_score < -0.2 ? 'bg-red-500' : 'bg-slate-500'}"
                         style="width: ${pct}%"></div>
                </div>
            </div>

            <!-- Sous-signaux mini -->
            <div class="grid grid-cols-5 gap-1 text-xs text-center">
                ${['technical', 'ml_model', 'sentiment', 'statistical', 'risk'].map(src => {
                    const s = sources[src] || {signal: 0, confidence: 0};
                    const color = s.signal > 0.1 ? 'text-emerald-400' : s.signal < -0.1 ? 'text-red-400' : 'text-slate-500';
                    const labels = {technical:'Tech', ml_model:'IA', sentiment:'Sent', statistical:'Prev', risk:'Risk'};
                    return `<div>
                        <div class="text-slate-600">${labels[src]}</div>
                        <div class="${color} font-mono">${s.confidence > 0 ? (s.signal > 0 ? '+' : '') + s.signal.toFixed(1) : '-'}</div>
                    </div>`;
                }).join('')}
            </div>

            <!-- Confiance -->
            <div class="mt-3 text-xs text-slate-500 text-right">
                Confiance: ${Math.round(result.confidence * 100)}%
            </div>
        </a>
    `;
}

// Charger les donnees
async function loadWatchlist() {
    try {
        const resp = await fetch('/api/advisor/watchlist');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const results = await resp.json();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // Top picks
        const buys = results.filter(r => r.composite_score > 0.1).slice(0, 5);
        const sells = results.filter(r => r.composite_score < -0.1).reverse().slice(0, 5);

        document.getElementById('top-buys').innerHTML =
            buys.length ? buys.map(renderPickRow).join('') :
            '<p class="text-slate-500 text-sm">Aucun signal d\'achat fort</p>';

        document.getElementById('top-sells').innerHTML =
            sells.length ? sells.map(renderPickRow).join('') :
            '<p class="text-slate-500 text-sm">Aucun signal de vente fort</p>';

        // Grille watchlist
        document.getElementById('watchlist-grid').innerHTML =
            results.map(renderTickerCard).join('');

    } catch (err) {
        document.getElementById('loading').innerHTML = `
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <p class="text-red-300">Erreur de chargement</p>
            <p class="text-slate-500 text-sm mt-2">${err.message}</p>
            <button onclick="loadWatchlist()" class="mt-4 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-sm">
                Reessayer
            </button>
        `;
    }
}

loadWatchlist();
</script>
{% endblock %}
