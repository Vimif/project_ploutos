{% extends "base.html" %}

{% block title %}Accueil - Ploutos Dashboard{% endblock %}

{% block content %}
<div class="grid">
    <div class="card">
        <div class="stat">
            <div id="portfolio-value" class="stat-value neutral">-</div>
            <div class="stat-label">Portfolio</div>
        </div>
    </div>
    
    <div class="card">
        <div class="stat">
            <div id="return-pct" class="stat-value neutral">-</div>
            <div class="stat-label">Return %</div>
        </div>
    </div>
    
    <div class="card">
        <div class="stat">
            <div id="trades-today" class="stat-value neutral">-</div>
            <div class="stat-label">Trades Aujourd'hui</div>
        </div>
    </div>
    
    <div class="card">
        <div class="stat">
            <div id="positions-count" class="stat-value neutral">-</div>
            <div class="stat-label">Positions Ouvertes</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>üíº Positions Ouvertes</h2>
    <div id="positions-container">
        <div class="loading">Chargement...</div>
    </div>
</div>

<div class="card">
    <h2>üìä Performance R√©cente</h2>
    <div id="performance-container">
        <div class="loading">Chargement...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadDashboard() {
        try {
            // Charger compte
            const accountResp = await fetch('/api/account');
            const accountData = await accountResp.json();
            
            if (accountData.success) {
                const acc = accountData.data;
                document.getElementById('portfolio-value').textContent = formatCurrency(acc.portfolio_value);
                
                // Calculer return
                const returnPct = ((acc.equity - acc.last_equity) / acc.last_equity * 100);
                const returnEl = document.getElementById('return-pct');
                returnEl.textContent = returnPct.toFixed(2) + '%';
                returnEl.className = 'stat-value ' + (returnPct > 0 ? 'positive' : returnPct < 0 ? 'negative' : 'neutral');
            }
            
            // Charger positions
            const posResp = await fetch('/api/positions');
            const posData = await posResp.json();
            
            if (posData.success) {
                const positions = posData.data;
                document.getElementById('positions-count').textContent = positions.length;
                
                // Afficher positions
                const positionsHtml = positions.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Symbole</th>
                                <th>Quantit√©</th>
                                <th>Prix d'Entr√©e</th>
                                <th>Prix Actuel</th>
                                <th>Valeur March√©</th>
                                <th>PnL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${positions.map(p => `
                                <tr>
                                    <td><strong>${p.symbol}</strong></td>
                                    <td>${p.qty.toFixed(2)}</td>
                                    <td>${formatCurrency(p.avg_entry_price)}</td>
                                    <td>${formatCurrency(p.current_price)}</td>
                                    <td>${formatCurrency(p.market_value)}</td>
                                    <td class="${p.unrealized_pl > 0 ? 'positive' : 'negative'}">
                                        ${formatCurrency(p.unrealized_pl)}
                                        <br>
                                        <small>(${p.unrealized_plpc.toFixed(2)}%)</small>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align:center;padding:20px;color:#64748b;">‚ùå Aucune position ouverte</p>';
                
                document.getElementById('positions-container').innerHTML = positionsHtml;
            }
            
            // Charger trades du jour
            const tradesResp = await fetch('/api/db/trades?days=1');
            const tradesData = await tradesResp.json();
            
            if (tradesData.success) {
                const today = new Date().toISOString().split('T')[0];
                const todayTrades = tradesData.data.filter(t => t.timestamp.startsWith(today));
                document.getElementById('trades-today').textContent = todayTrades.length;
            }
            
            // Charger performance
            const perfResp = await fetch('/api/performance');
            const perfData = await perfResp.json();
            
            if (perfData.success) {
                const perf = perfData.data;
                
                const perfHtml = `
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="stat">
                            <div class="stat-value ${perf.total_unrealized_plpc > 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(perf.total_unrealized_pl)}
                            </div>
                            <div class="stat-label">PnL Total Non R√©alis√©</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-value ${perf.win_rate > 50 ? 'positive' : 'negative'}">
                                ${perf.win_rate.toFixed(1)}%
                            </div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                        
                        <div class="stat">
                            <div class="stat-value neutral">
                                ${perf.winning_positions} / ${perf.losing_positions}
                            </div>
                            <div class="stat-label">Gagnantes / Perdantes</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('performance-container').innerHTML = perfHtml;
            }
            
        } catch (error) {
            console.error('‚ùå Erreur chargement dashboard:', error);
            
            // Afficher message d'erreur
            document.getElementById('positions-container').innerHTML = 
                '<p style="color:#ef4444;text-align:center;padding:20px;">‚ùå Erreur de connexion. V√©rifiez que le bot est actif.</p>';
            document.getElementById('performance-container').innerHTML = 
                '<p style="color:#ef4444;text-align:center;padding:20px;">‚ùå Erreur de connexion.</p>';
        }
    }
    
    // Chargement initial
    loadDashboard();
    
    // Rafra√Æchir toutes les 10 secondes
    setInterval(loadDashboard, 10000);
</script>
{% endblock %}