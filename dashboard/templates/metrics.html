{% extends "base.html" %}

{% block title %}M√©triques - Ploutos Dashboard{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: #1e293b;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #334155;
        text-align: center;
    }
    
    .metric-title {
        color: #94a3b8;
        font-size: 0.9em;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .metric-value-large {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .metric-subtitle {
        color: #64748b;
        font-size: 0.85em;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    
    .info-box {
        background: #334155;
        border-left: 4px solid #60a5fa;
        padding: 15px;
        margin: 20px 0;
        border-radius: 6px;
    }
    
    .info-box h4 {
        color: #60a5fa;
        margin-bottom: 8px;
    }
    
    .info-box p {
        color: #94a3b8;
        font-size: 0.95em;
        line-height: 1.6;
    }
    
    .symbol-row {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #334155;
    }
    
    .symbol-row:hover {
        background: #334155;
    }
    
    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .filter-group select {
        background: #334155;
        border: 1px solid #475569;
        color: #e2e8f0;
        padding: 8px 12px;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Filtres -->
<div class="card">
    <div class="filters">
        <div class="filter-group">
            <label for="filter-days" style="color: #94a3b8; margin-bottom: 5px; display: block;">P√©riode d'analyse</label>
            <select id="filter-days" onchange="loadMetrics()">
                <option value="7">7 jours</option>
                <option value="14">14 jours</option>
                <option value="30" selected>30 jours</option>
                <option value="60">60 jours</option>
                <option value="90">90 jours</option>
            </select>
        </div>
    </div>
</div>

<!-- Ratios de Performance -->
<div class="card">
    <h2>üìä Ratios de Performance</h2>
    <div class="info-box">
        <h4>üí° Interpr√©tation des ratios</h4>
        <p>
            <strong>Sharpe Ratio:</strong> Mesure le rendement ajust√© au risque. > 1 = Bon, > 2 = Tr√®s bon, > 3 = Excellent.<br>
            <strong>Sortino Ratio:</strong> Comme Sharpe mais p√©nalise uniquement la volatilit√© baissi√®re (plus r√©aliste).<br>
            <strong>Calmar Ratio:</strong> Rapport entre rendement et drawdown maximum. > 1 = Bon, > 3 = Excellent.
        </p>
    </div>
    
    <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="metric-card">
            <div class="metric-title">Sharpe Ratio</div>
            <div id="sharpe-ratio" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle">Rendement / Risque</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Sortino Ratio</div>
            <div id="sortino-ratio" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle">Downside Risk</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Calmar Ratio</div>
            <div id="calmar-ratio" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle">Rendement / Drawdown</div>
        </div>
    </div>
</div>

<!-- M√©triques de Risque -->
<div class="card">
    <h2>‚ö†Ô∏è M√©triques de Risque</h2>
    <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="metric-card">
            <div class="metric-title">Max Drawdown</div>
            <div id="max-drawdown" class="metric-value-large negative">-</div>
            <div class="metric-subtitle">
                <span id="dd-dates" style="font-size: 0.8em;">-</span>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Volatilit√© Annuelle</div>
            <div id="volatility" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle">√âcart-type rendements</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">VaR 95%</div>
            <div id="var-95" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle">Value at Risk</div>
        </div>
    </div>
</div>

<!-- Win/Loss Analytics -->
<div class="card">
    <h2>üéØ Win/Loss Analytics</h2>
    <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
        <div class="metric-card">
            <div class="metric-title">Win Rate</div>
            <div id="win-rate" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle" id="win-loss-detail">-</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Gain Moyen</div>
            <div id="avg-win" class="metric-value-large positive">-</div>
            <div class="metric-subtitle">Par trade gagnant</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Perte Moyenne</div>
            <div id="avg-loss" class="metric-value-large negative">-</div>
            <div class="metric-subtitle">Par trade perdant</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Profit Factor</div>
            <div id="profit-factor" class="metric-value-large neutral">-</div>
            <div class="metric-subtitle">Gains / Pertes</div>
        </div>
    </div>
</div>

<!-- Top Symboles -->
<div class="card">
    <h2>üèÜ Top Symboles</h2>
    <div id="top-symbols-container">
        <div class="loading">Chargement...</div>
    </div>
</div>

<!-- √âvolution Portfolio -->
<div class="card">
    <h2>üìà √âvolution du Portfolio</h2>
    <div class="chart-container">
        <canvas id="portfolio-chart"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let portfolioChart = null;
    
    async function loadMetrics() {
        try {
            const days = document.getElementById('filter-days').value;
            
            // Charger les analytics avanc√©s
            const response = await fetch(`/api/analytics/advanced?days=${days}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Erreur chargement m√©triques');
            }
            
            const metrics = data.data;
            
            // Performance Ratios
            updateRatio('sharpe-ratio', metrics.performance_ratios.sharpe_ratio);
            updateRatio('sortino-ratio', metrics.performance_ratios.sortino_ratio);
            updateRatio('calmar-ratio', metrics.performance_ratios.calmar_ratio);
            
            // Risk Metrics
            document.getElementById('max-drawdown').textContent = 
                metrics.risk_metrics.max_drawdown_pct.toFixed(2) + '%';
            document.getElementById('dd-dates').textContent = 
                `${metrics.risk_metrics.max_drawdown_start} ‚Üí ${metrics.risk_metrics.max_drawdown_end}`;
            
            // Win/Loss
            const wl = metrics.win_loss;
            document.getElementById('win-rate').textContent = wl.win_rate_pct.toFixed(1) + '%';
            document.getElementById('win-loss-detail').textContent = 
                `${wl.wins}W / ${wl.losses}L`;
            document.getElementById('avg-win').textContent = formatCurrency(wl.avg_win);
            document.getElementById('avg-loss').textContent = formatCurrency(wl.avg_loss);
            document.getElementById('profit-factor').textContent = wl.profit_factor.toFixed(2);
            
            // Top Symboles
            displayTopSymbols(metrics.by_symbol);
            
            // Charger √©volution
            loadEvolution(days);
            
        } catch (error) {
            console.error('Erreur loadMetrics:', error);
        }
    }
    
    function updateRatio(elementId, value) {
        const el = document.getElementById(elementId);
        el.textContent = value.toFixed(2);
        
        // Colorier selon la valeur
        el.classList.remove('positive', 'negative', 'neutral');
        if (value > 1) {
            el.classList.add('positive');
        } else if (value < 0) {
            el.classList.add('negative');
        } else {
            el.classList.add('neutral');
        }
    }
    
    function displayTopSymbols(bySymbol) {
        const symbols = Object.entries(bySymbol)
            .sort((a, b) => b[1].total_volume - a[1].total_volume)
            .slice(0, 10);
        
        if (symbols.length === 0) {
            document.getElementById('top-symbols-container').innerHTML = 
                '<p style="text-align: center; padding: 20px; color: #94a3b8;">Aucune donn√©e</p>';
            return;
        }
        
        const html = symbols.map(([symbol, stats]) => `
            <div class="symbol-row">
                <div>
                    <strong style="color: #60a5fa;">${symbol}</strong>
                    <span style="color: #64748b; font-size: 0.9em; margin-left: 10px;">
                        ${stats.total_trades} trades
                    </span>
                </div>
                <div>
                    <span style="color: #10b981;">${stats.buy_count} BUY</span>
                    <span style="color: #94a3b8; margin: 0 5px;">/</span>
                    <span style="color: #ef4444;">${stats.sell_count} SELL</span>
                    <span style="margin-left: 15px; font-weight: bold;">
                        ${formatCurrency(stats.total_volume)}
                    </span>
                </div>
            </div>
        `).join('');
        
        document.getElementById('top-symbols-container').innerHTML = html;
    }
    
    async function loadEvolution(days) {
        try {
            const response = await fetch(`/api/db/evolution?days=${days}`);
            const data = await response.json();
            
            if (!data.success || data.data.length === 0) {
                return;
            }
            
            const evolution = data.data;
            const labels = evolution.map(e => e.date);
            const values = evolution.map(e => e.portfolio_value || 0);
            
            // D√©truire le graphique existant
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            // Cr√©er le nouveau graphique
            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valeur Portfolio',
                        data: values,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('Erreur loadEvolution:', error);
        }
    }
    
    // Chargement initial
    loadMetrics();
    
    // Rafra√Æchir toutes les minutes
    setInterval(loadMetrics, 60000);
</script>
{% endblock %}